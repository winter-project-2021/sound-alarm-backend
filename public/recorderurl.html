<!DOCTYPE html>
<html>
  <head>
    <title>audiofp</title>
  </head>
  <body>
    <h1>audiofp</h1>

    <button class= 'a'>감지시작</button>
    <button class= 'b'>감지중단</button>
    <audio controls></audio>
    <audio controls class="show"></audio>
    <div class='result'></div>
    <script>

    var audio=document.querySelector('audio');
    var a = document.querySelector('.a')
    var b = document.querySelector(".b");
    var clicked = false;
    var chunks = [];
       

     if (navigator.mediaDevices) {
    console.log('getUserMedia supported.');
    navigator.mediaDevices.getUserMedia ({audio: true})
    .then(function(stream) {
        audio.srcObject = stream;
      
     var ac = new AudioContext();
     var source = ac.createMediaStreamSource(stream);
     var rec= new Recorder(source);
     

     

     a.addEventListener("click", function(e) {
            console.log('start'); 
            var detect= setInterval(function(){
            rec.record();
            setTimeout (function(){
              rec.stop();
              rec.exportWAV(function(blob){
                var url = URL.createObjectURL(blob);
                  var hf = document.createElement('a');
                  hf.href = url;
                  hf.download = new Date().toISOString() + '.wav';
                  hf.innerHTML = hf.download;
                  hf.click();
                  hf.remove(); })
              rec.clear();
            },4000);
            },6000);
           

           b.addEventListener('click',function(e){
              clearInterval(detect);
              rec.stop();
              rec.exportWAV(function(blob){
                var url = URL.createObjectURL(blob);
                  var hf = document.createElement('a');
                  hf.href = url;
                  hf.download = new Date().toISOString() + '.wav';
                  hf.innerHTML = hf.download;
                  window.location.assign(url);
                  window.URL.revokeObject(url); 
              })
              rec.clear();
              console.log('off');
              });
          });

    
          
    })
  }
  function sendAjax(url,data){
    var xhr= new XMLHttpRequest();
    var formdata= new FormData();
    formdata.append("please",data);
    xhr.open('post',url)
    // xhr.setRequestHeader('Content-Type', 'multipart/form-data')
    xhr.responseType = 'text'
    xhr.onload = function(e){
      var result= JSON.parse(xhr.responseText);
      var show= document.querySelector('.result')
      if (result.result=='success') show.innerHTML="result.meaning";
      else show.innerHTML='not found';
    }
    xhr.send(formdata)
  }
       
    </script>
    <script type="module" src= './recorder.js'public\recorder.js></script>
  </body>
</html>