<!DOCTYPE html>
<html>
  <head>
    <title>audiofp</title>
  </head>
  <body>
    <h1>audiofp</h1>

    <button class= 'a'>감지시작</button>
    <button class= 'b'>감지중단</button>
    <audio controls></audio>
    <div class='result'></div>

    <div>
      <div><label for='music'> upload original</label>
        <input type ="file" id='music' name='music' accept="audio/*" required>
        <input type ='text' id='text'  name='text'>
      </div>
      <button class='login'>login</button>
      <button class='s'>Submit</button>
      <button class='d'>delete</button>
      <button class='u'>update</button>
      <button class='ts'>textSubmit</button>
      <button class='td'>textdelete</button>
      <button class='tu'>textupdate</button>
      <button class='set'>setting</button>
      <button class='test'>mode</button>

    <div>

  </div>

    <script>

    var audio=document.querySelector('audio');
    var login=document.querySelector('.login');
    var a = document.querySelector('.a');
    var b = document.querySelector('.b');
    var c = document.querySelector('music');
    var s = document.querySelector('.s'); 
    var d = document.querySelector('.d');
    var u = document.querySelector('.u');
    var ts = document.querySelector('.ts');
    var td = document.querySelector('.td');
    var tu = document.querySelector('.tu');
    var set = document.querySelector('.set');
    var test = document.querySelector('.test');

    var clicked = false;
    var chunks = [];
    var mode="compare";
    var user={
      username:'gildong'
    }
    var audioid=[];
    var textid=[];
       

     if (navigator.mediaDevices) {
    console.log('getUserMedia supported.');
    navigator.mediaDevices.getUserMedia ({audio: true})
    .then(function(stream) {
        audio.srcObject = stream;
     var ac = new AudioContext();
     var source = ac.createMediaStreamSource(stream); 
     
     var dest = ac.createMediaStreamDestination();
     var mediaRecorder = new MediaRecorder(dest.stream);
     source.connect(dest);
     
     

     mediaRecorder.ondataavailable = function(evt) {
  
       chunks.push(evt.data);
       var blob = new Blob(chunks, { 'type' : 'audio/wav' });
       console.log(blob);
      sendAjax('http://localhost:3000/audio/test',blob);//blob을 해당 주소로 보냄.
       chunks=[]
     };

     a.addEventListener("click", function(e) {
          mediaRecorder.start();
          console.log('start')
          });
     
          b.addEventListener('click',function(e){
              mediaRecorder.stop();
              console.log('off');
              });




      //가상 login
      login.addEventListener("click",function(e){
      console.log(user);
      var formdata= new FormData();
      formdata.append("username",user.username);

      for (var pair of formdata.entries()) { console.log(pair[0]+ ', ' + pair[1]); }
    
      axios.post('http://localhost:3000/',formdata
      ,{
      headers: {
        'Content-Type': 'multipart/form-data'
      }}
    )
    .then(response=>{
      console.log(response.data)
      user=response.data
      console.log(user);
    })

  })
      //setting 변경 : default => language: '한국어',alarmpush: true, alarmsound: 1, alarm: true,
      set.addEventListener("click",function(e){
        axios.put('http://localhost:3000/setting',{
        _id: user._id,
        language: 'english',
        alarmpush: true,
        alarmsound: 1,
        alarm: false
      
    }).then(response=>{
      console.log(response.data);
     })
       })

      //audio 등록, 이름 변경, 삭제    
      s.addEventListener("click",function(e){
      let file=document.getElementById('music');
      let text=document.getElementById('text');     
      var formdata= new FormData();
      formdata.append("data",file.files[0]);
      formdata.append("name",text.value);
      formdata.append("_id",user._id);
      formdata.append("username",user.username);

      for (var pair of formdata.entries()) { console.log(pair[0]+ ', ' + pair[1]); }
    
      axios.post('http://localhost:3000/audio',formdata
      ,{
      headers: {
        'Content-Type': 'multipart/form-data'
      }}
    )
    .then(response=>{
      console.log(response.data)
      audioid.push(response.data._id)
      console.log(audioid);
    })
  })

    d.addEventListener('click',function(e){
      console.log('delete');
      console.log(audioid);
      axios.delete('http://localhost:3000/audio',{
        data:{
          _id: user._id,
          audioid:audioid[audioid.length-1]
        }
      }).then(response=>{
        console.log(response.data);
        audioid.pop();
       })
  })

    u.addEventListener('click',function(e){
      console.log('update');
      console.log(audioid);
      axios.put('http://localhost:3000/audio',{
        
          _id: user._id,
          audioid:audioid[0],
          name: 'changed',
          sensitivity: 5
        
      }).then(response=>{
        console.log(response.data);
       })
    })



    //text 등록, 이름 변경, 삭제    
    ts.addEventListener("click",function(e){
      let text=document.getElementById('text');
      console.log(text.value)
      var formdata=new FormData();
      formdata.append("text",text.value);
      formdata.append("_id",user._id);
      formdata.append("username",user.username);

      for (var pair of formdata.entries()) { console.log(pair[0]+ ', ' + pair[1]); }
    
      axios.post('http://localhost:3000/text',formdata
      ,{
      headers: {
        'Content-Type': 'multipart/form-data'
      }}
    )
    .then(response=>{
      console.log(response.data)
      textid.push(response.data._id)
    })
  })
      td.addEventListener('click',function(e){
      console.log('delete');
      console.log(textid);
      axios.delete('http://localhost:3000/text',{
        data:{
          _id: user._id,
          textid:textid[textid.length-1]
        }
      }).then(response=>{
        console.log(response.data);
        textid.pop();
       })
      })

       tu.addEventListener('click',function(e){
      console.log('update');
      console.log(textid);
      axios.put('http://localhost:3000/text',{
        
          _id: user._id,
          textid:textid[0],
          text: 'changed'
        
      }).then(response=>{
        console.log(response.data);
       })
      })


    })

    test.addEventListener('click',function(e){
      if(mode==="compare") {mode="test";}
      else{ mode="compare";}
      console.log(mode)
    })


  }



  function sendAjax(url,data){
       var formdata= new FormData();
       formdata.append("data",data);
      formdata.append("_id",user._id)
       if(mode==='compare'){
        formdata.append("mode","compare");
       }else if(mode==='test'){
        formdata.append('audioid',audioid);
        formdata.append('sensitivity',80);
        formdata.append("mode","test")
       }
       for (var pair of formdata.entries()) { console.log(pair[0]+ ', ' + pair[1]); }
      
      axios.post(url,formdata
      ,{
      headers: {
        'Content-Type': 'multipart/form-data'
      }}
    )
    .then(response=>{
      console.log(response.data)
    })
  }
     

   
    </script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </body>
</html>