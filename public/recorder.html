<!DOCTYPE html>
<html>
  <head>
    <title>audiofp</title>
  </head>
  <body>
    <h1>audiofp</h1>

    <button class= 'a'>감지시작</button>
    <button class= 'b'>감지중단</button>
    <audio controls></audio>
    <div class='result'></div>

    <div>
    <form action="/" method="post" enctype="multipart/form-data">
      <div><label for='name'>music name</label>
        <input type='text' id='name' value="" name="name" required> 
      </div>
      <div><label for='music'> upload original</label>
        <input type ="file" id='music' name='music' value="" required>
      </div>
      <button type="submit">Submit</button>
    </form>
  </div>

    <script>

    var audio=document.querySelector('audio');
    var a = document.querySelector('.a')
    var b = document.querySelector('.b');
    var clicked = false;
    var chunks = [];
       

     if (navigator.mediaDevices) {
    console.log('getUserMedia supported.');
    navigator.mediaDevices.getUserMedia ({audio: true})
    .then(function(stream) {
        audio.srcObject = stream;
     var ac = new AudioContext();
     var source = ac.createMediaStreamSource(stream);
    
     var dest = ac.createMediaStreamDestination();
     var mediaRecorder = new MediaRecorder(dest.stream);
     source.connect(dest);
     
     

     mediaRecorder.ondataavailable = function(evt) {
       // push each chunk (blobs) in an array
       chunks.push(evt.data);
       var blob = new Blob(chunks, { 'type' : 'audio/wav' });
       console.log(blob);
      sendAjax('http://127.0.0.1:3000/ajax',blob);
       chunks=[]
     };

     a.addEventListener("click", function(e) {
          mediaRecorder.start();
           b.addEventListener('click',function(e){
              //clearInterval(detect);
              mediaRecorder.stop();
              console.log('off');
              });
          });
    })
  }


  function sendAjax(url,data){
    var xhr= new XMLHttpRequest();
    var formdata= new FormData();
    formdata.append("please",data);
    xhr.open('post',url)
    xhr.responseType = 'text'
    xhr.onload = function(e){
      var result= JSON.parse(xhr.responseText);
      var show= document.querySelector('.result')
      if (result.result=='success') show.innerHTML="result.meaning";
      else show.innerHTML='not found';
    }
    xhr.send(formdata)
  }
     

   
    </script>
  </body>
</html>